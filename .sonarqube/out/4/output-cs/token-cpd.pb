Ì*
íC:\Projects\eng-software-unisinos\Unisinos.EngSoftware.EShop\src\BuildingBlocks\WebHost\BuildingBlocks.WebHost.Customization\IWebHostExtensions.cs
	namespace		 	
BuildingBlocks		
 
.		 
WebHost		  
.		  !
Customization		! .
{

 
public 

static 
class 
IWebHostExtensions *
{ 
public 
static 
IWebHost 
MigrateDbContext /
</ 0
TContext0 8
>8 9
(9 :
this: >
IWebHost? G
webHostH O
,O P
ActionQ W
<W X
TContextX `
,` a
IServiceProviderb r
>r s
seedert z
)z {
where	| Å
TContext
Ç ä
:
ã å
	DbContext
ç ñ
{ 	
using 
( 
var 
scope 
= 
webHost &
.& '
Services' /
./ 0
CreateScope0 ;
(; <
)< =
)= >
{ 
var 
services 
= 
scope $
.$ %
ServiceProvider% 4
;4 5
var 
logger 
= 
services %
.% &
GetRequiredService& 8
<8 9
ILogger9 @
<@ A
TContextA I
>I J
>J K
(K L
)L M
;M N
var 
context 
= 
services &
.& '

GetService' 1
<1 2
TContext2 :
>: ;
(; <
)< =
;= >
try 
{ 
logger 
. 
LogInformation )
() *
$str* f
,f g
typeofh n
(n o
TContexto w
)w x
.x y
Namey }
)} ~
;~ 
var 
retries 
=  !
$num" $
;$ %
var 
retry 
= 
Policy  &
.& '
Handle' -
<- .
SqlException. :
>: ;
(; <
)< =
. 
WaitAndRetry %
(% &

retryCount &
:& '
retries( /
,/ 0!
sleepDurationProvider 1
:1 2
retryAttempt3 ?
=>@ B
TimeSpanC K
.K L
FromSecondsL W
(W X
MathX \
.\ ]
Pow] `
(` a
$numa b
,b c
retryAttemptd p
)p q
)q r
,r s
onRetry #
:# $
(% &
	exception& /
,/ 0
timeSpan1 9
,9 :
retry; @
,@ A
ctxB E
)E F
=>G I
{ 
logger    &
.  & '

LogWarning  ' 1
(  1 2
	exception  2 ;
,  ; <
$str	  = £
,
  £ §
nameof
  • ´
(
  ´ ¨
TContext
  ¨ ¥
)
  ¥ µ
,
  µ ∂
	exception
  ∑ ¿
.
  ¿ ¡
GetType
  ¡ »
(
  » …
)
  …  
.
    À
Name
  À œ
,
  œ –
	exception
  — ⁄
.
  ⁄ €
Message
  € ‚
,
  ‚ „
retry
  ‰ È
,
  È Í
retries
  Î Ú
)
  Ú Û
;
  Û Ù
}!! 
)!! 
;!! 
retry'' 
.'' 
Execute'' !
(''! "
(''" #
)''# $
=>''% '
InvokeSeeder''( 4
(''4 5
seeder''5 ;
,''; <
context''= D
,''D E
services''F N
)''N O
)''O P
;''P Q
logger)) 
.)) 
LogInformation)) )
())) *
$str))* e
,))e f
typeof))g m
())m n
TContext))n v
)))v w
.))w x
Name))x |
)))| }
;))} ~
}** 
catch++ 
(++ 
	Exception++  
ex++! #
)++# $
{,, 
logger-- 
.-- 
LogError-- #
(--# $
ex--$ &
,--& '
$str--( x
,--x y
typeof	--z Ä
(
--Ä Å
TContext
--Å â
)
--â ä
.
--ä ã
Name
--ã è
)
--è ê
;
--ê ë
}.. 
}// 
return11 
webHost11 
;11 
}22 	
private44 
static44 
void44 
InvokeSeeder44 (
<44( )
TContext44) 1
>441 2
(442 3
Action443 9
<449 :
TContext44: B
,44B C
IServiceProvider44D T
>44T U
seeder44V \
,44\ ]
TContext44^ f
context44g n
,44n o
IServiceProvider	44p Ä
services
44Å â
)
44â ä
where55 
TContext55 
:55 
	DbContext55 &
{66 	
context77 
.77 
Database77 
.77 
Migrate77 $
(77$ %
)77% &
;77& '
seeder88 
(88 
context88 
,88 
services88 $
)88$ %
;88% &
}99 	
}:: 
};; 